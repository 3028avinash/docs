{{ define "li" -}}
  {{ $page := .page -}}
  {{ $pages := .pages -}}

  {{ range $pages -}}
    {{ $isActive := eq $page . -}}
    {{ $isActivePath := $page.IsDescendant . -}}
    {{ $childPages := (union .Pages .Sections).ByWeight -}}
    <li class="my-2">
      <a class="pl-6 flex {{ if $isActive }} active text-redis-ink-900 {{ else }} text-redis-pen-700 hover:text-redis-pen-600 {{ end }}" href="{{.RelPermalink}}">
        {{ if gt (len $childPages) 0 }}
          {{ if or $isActive $isActivePath -}}
            <span class="pr-0"></span>
          {{ else -}}
            <span class="pr-0"></span>
          {{ end -}}
        {{ end -}}
        <span>{{.LinkTitle}}</span>
      </a>
    </li>
    {{ if and (gt (len $childPages) 0) (or $isActive $isActivePath)}}
      <ul class="child-list">
        {{ template "li" (dict "page" $page "pages" $childPages) }}
      </ul>
    {{ end }}
  {{- end }}
{{- end }}


{{ $base := .Site.BaseURL }}
{{ $parsed := urls.Parse $base }}
{{ $path := $parsed.Path }}
{{ if (eq $path "/") }}
  {{ .Scratch.Set "path" ""}}
{{ else }}
  {{ .Scratch.Set "path" $path}}
{{ end }}

{{ define "navChildList" -}}
{{ $item := .item -}}
{{ $currentPageRelRef := .currentPageRelRef -}}
{{ $hidden := not ( hasPrefix $currentPageRelRef $item.relref )}}
<ul class="child-list{{ if $hidden }} hidden{{ end }}">
  {{ range $item.children }}
  {{ $isActive := hasPrefix $currentPageRelRef .relref }}
  {{- if .divider }}
  <li class="my-2 bg-redis-pencil-200" inert="yes"><strong><span class="pr-5"></span>{{ .linkTitle }}</strong>
  {{- else if .children }}
  <li class="my-2"><a href="{{ .relref }}" class="pl-6 flex{{ if $isActive }} active text-redis-ink-900 {{ else }} text-redis-pen-700 hover:text-redis-pen-600 {{ end }}"><span class="pr-5"></span>{{ .linkTitle }}<span class="pr-2"></span>
    <svg class="arrow-closed" style="display: inline;" width="18" height="18" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <!--<polyline class="arrow-closed" points="3 6 9 12 15 6" fill="black" />-->
      <polyline class="arrow-closed" points="3 11 15 11 9 6" fill="black" />
      <polyline class="arrow-closed" points="3 13 9 18 15 13" fill="black" />
    </svg>
  {{- template "navChildList" ( dict "item" . "currentPageRelRef" $currentPageRelRef )}}
  {{- else }}
  <li class="my-2"><a href="{{ .relref }}" class="pl-6 flex{{ if $isActive }} active text-redis-ink-900 {{ else }} text-redis-pen-700 hover:text-redis-pen-600 {{ end }}"><span class="pr-5"></span>{{ .linkTitle }}</a>
  {{- end -}}
  </li>
  {{ end }}  
</ul>
{{- end }}

{{ define "navList" -}}
{{ $root := .root -}}
{{ $currentPage := $.currentPage }}
<ul class="md:block overflow-y-auto grow pr-0  border-opacity-50 border-redis-ink-900">
  {{ range $root.children -}}
  {{ $isActive := hasPrefix $currentPage.RelPermalink .relref }}
  {{- if .divider }}
  <li class="my-2 bg-redis-pencil-500 text-white text-center" inert="yes"><span class="pr-5"></span><strong>{{ .linkTitle }}</strong>
  {{- else if .children }}
  <li class="my-2"><span class="pr-5"></span><a href="{{ .relref }}" class="{{ if $isActive }} active text-redis-ink-900 {{ else }} text-redis-pen-700 hover:text-redis-pen-600 {{ end }}">{{ .linkTitle }}
    <svg class="arrow-closed" style="display: inline;" width="18" height="18" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <!--<polyline class="arrow-closed" points="3 6 9 12 15 6" fill="black" />-->
      <polyline class="arrow-closed" points="3 8 15 8 9 3" fill="black" />
      <polyline class="arrow-closed" points="3 10 9 15 15 10" fill="black" />
    </svg>
  </a>
  {{- template "navChildList" ( dict "item" . "currentPageRelRef" $currentPage.RelPermalink )}}
  {{- else }}
  <li class="my-2"><span class="pr-5"></span><a href="{{ .relref }}"  class="{{ if $isActive }} active text-redis-ink-900 {{ else }} text-redis-pen-700 hover:text-redis-pen-600 {{ end }}">{{ .linkTitle }}</a>
  {{- end -}}
  </li>
  {{ end }}  
</ul>
{{- end }}

<div class="md:block w-full md:w-96 h-fit md:h-full shrink-0 text-base font-mono font-normal py-6">
  <nav id="sidebar" class="max-h-[calc(100vh-7rem)] min-h-96 flex flex-col gap-4 w-full md:w-96 z-40 bg-white md:fixed md:pt-6 h-fit md:h-full leading-7">
    {{ $navRoot := cond (eq .Site.Home.Type "docs") .Site.Home .FirstSection -}}
    {{ $ulNr := 0 -}}
    {{ $ulShow := 1 -}}
      <div class='min-h-0  border border-opacity-50 border-redis-ink-900 rounded-md flex flex-col {{ if not (in (slice "Develop" "Integrate" "Operate") $navRoot.LinkTitle) }} shrink-0 {{ end }}'>
        <a class='px-6 py-4 rounded-t-md hover:bg-redis-pen-200 {{ if eq $navRoot.LinkTitle "Develop" }} font-bold {{ end }}' href='{{ .Scratch.Get "path" }}/develop'>Develop with Redis</a>
        {{ if eq $navRoot.LinkTitle "Develop" }}
        <ul class="md:block overflow-y-auto grow pr-6 border-t border-opacity-50 border-redis-ink-900">
          {{- template "navList" ( dict "root" .Site.Data.nav "currentPage" . )}}
        </ul>
        {{ end }}
        <a class='px-6 py-4 hover:bg-redis-pen-200 border-t border-redis-ink-900 border-opacity-50 {{ if eq $navRoot.LinkTitle "Integrate" }} font-bold {{ end }}' href='{{ .Scratch.Get "path" }}/integrate'>Libraries and tools</a>
        {{ if eq $navRoot.LinkTitle "Integrate" }}
          <ul class="md:block overflow-y-auto grow pr-6 border-t border-opacity-50 border-redis-ink-900">
            {{ template "li" (dict "page" . "pages" (union $navRoot.Pages $navRoot.Sections).ByWeight) }}
          </ul>
        {{ end }}
        <a class='px-6 py-4 rounded-b-md hover:bg-redis-pen-200 border-t border-redis-ink-900 border-opacity-50 {{ if eq $navRoot.LinkTitle "Operate" }} font-bold {{ end }}' href='{{ .Scratch.Get "path" }}/operate'>Redis products</a>
        {{ if eq $navRoot.LinkTitle "Operate" }}
          <ul class="md:block overflow-y-auto grow pr-6 border-t border-opacity-50 border-redis-ink-900">
            {{ template "li" (dict "page" . "pages" (union $navRoot.Pages $navRoot.Sections).ByWeight) }}
          </ul>
        {{ end }}
      </div>
      <div class='min-h-0 border border-opacity-50 border-redis-ink-900 rounded-md flex flex-col {{ if not (eq $navRoot.LinkTitle "Commands") }} shrink-0 {{ end }}'>
        <a class='px-6 py-4 hover:bg-redis-pen-200 text-redis-red-600 {{ if eq $navRoot.LinkTitle "Commands" }} font-bold {{ end }}' href='{{ .Scratch.Get "path" }}/commands'>Commands</a>
        {{ if eq $navRoot.LinkTitle "Commands" }}
          <ul class="md:block overflow-y-auto grow pr-6 border-t border-opacity-50 border-redis-ink-900">
            {{ template "li" (dict "page" . "pages" (union $navRoot.Pages $navRoot.Sections).ByWeight) }}
          </ul>
        {{ end }}
      </div>
  </div>
  </nav>
</div>

<script>
  function getParentListItem(element) {
    var parentLi = element.parentElement;

    while ((parentLi !== null) && (parentLi.nodeName !== "LI")) {
      parentLi = parentLi.parentElement;
    }

    return parentLi;
  }


  document.addEventListener("DOMContentLoaded", function() {
    const sidebar = document.getElementById('sidebar');
    const footer = document.querySelector('footer');

    window.addEventListener('scroll', function() {
      const scrolledHeight = window.scrollY + window.innerHeight;
      if (scrolledHeight >= footer.offsetTop) {
          sidebar.style.maxHeight = `calc(100vh - 7rem - ${scrolledHeight - footer.offsetTop}px)`;
        } else {
        sidebar.style.maxHeight = 'calc(100vh - 7rem)';
      }
    });
  

    // On click, get the ul with id child-list-id and toggle it
    window.addEventListener('click', function(event) {
      // If -> then unwrap, if ↓ then wrap
        if (event.target.classList.contains("arrow-closed")) {
          const parentLi = getParentListItem(event.target);
          const subLists = parentLi.getElementsByTagName("ul");

          if (subLists.length > 0) {
            subLists[0].classList.remove('hidden');
            // Change the target innerText to ↓
            event.target.classList.remove("arrow-closed");
            event.target.classList.add("arrow-open");
            event.preventDefault();
          }
          
        } else if (event.target.classList.contains("arrow-open")) {
          const parentLi = getParentListItem(event.target);
          // Add hidden to the classList
          const subLists = parentLi.getElementsByTagName("ul");

          if (subLists.length > 0) {
            subLists[0].classList.add('hidden');
            // Change the target innerText to →
            event.target.classList.remove("arrow-open");
            event.target.classList.add("arrow-closed");
            event.preventDefault();
          }
        }
      
  });
})
</script>
